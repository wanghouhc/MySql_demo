# MySql优化

## 1.索引

### 1.1 索引结构

![](\img\1.索引结构.png)

#### 1.BTREE

![](img\2.BTREE结构.png)

#### 2.B+TREE

![](img\3.B+TREE.png)

什么是B+TREE 作为一种数据结构，他的实现原理还是基于数的结构，只是在通常的二叉树的基础上进行更大的分叉，数值的大小以及此值所在的左右指针来为下一个数进行指定位置

#### 3.MYSQL中的B+TREE

![](img\4.mysql中的B+TREE.png)

### 1.2 索引的分类

#### 1.什么是索引

视图就是一张表，怎么操作表就怎么操作视图，他的主要作用就是将我们需要的字段汇聚成一张新的虚拟表

#### 2.索引的分类

按照创建索引时字段数以及所在列的情况来区分

![](\img\5.png)

#### 3.创建索引的语法

![](img\6.png)

##### 1.创建索引

![](img\7.png)

##### 2.删除索引

![](img\9.png)

##### 3.索引中的alert命令

![](img\10.png)

##### 4.索引的设计原则

![](img\13.png)

### 1.3视图

#### 1.什么是视图

![](img\14.png)

视图类似于一张自定义的临时表

#### 2.创建或修改视图

![](img\16.png)

![](img\17.png)

##### 1.创建视图

![](img\18.png)

##### 2.删除视图

![](img\19.png)

### 1.4存储过程

#### 1.什么是存储过程/创建

![](img\20.png)

```
存储过程--一组sql语句的集合

set存储过程为变量赋值

@descripate  @代表用户的变量

select concat（）传输出结果，输出函数

存储函数使用 select 存储函数 来调用

存储引擎是基于表的，而不是基于库的
```

#### 2.调用存储过程

![](img\21.png)

#### 3.查看存储过程

![](img\22.png)

#### 4.删除存储过程

![](img\23.png)

#### 5.语法

```
sql中默认的分隔符是 ；，一条sql只有在最后面写上；，才表示此条sql结束
delimiter $ 表示替换分割符
```



##### 5.1变量

![](img\24.png)

##### 5.2 if条件判断

![](\img\27.png)

##### 5.3 传递参数

###### 1.IN 输入值

![](img\28.png)

![](img\29.png)

###### 2.OUT 输出值

![](img\30.png)

###### 3.IN和OUT组合

![](\img\31.png)

###### 4.case结构

ceae里面可以存放一些条件

![](img\33.png)

![](img\34.png)

###### 5.loop语句

![](\img\35.存储过程_loop循环.png)

###### 6.repeat循环

![](img\35.存储过程_repeat循环.png)

![](\img\35.存储过程_repeat循环2.png)

###### 7.while循环

![](\img\35.存储过程_while循环.png)

###### 8.leave语句

![](\img\38.leave.png)

![](\img\38.png)

9.游标/光标

游标和光标的最主要作用就是我们可以使用他来对我们的返回数据进行第二次加工

![](img\39.存储过程_游标.png)

![](\img\40.存储过程_游标的使用.png)

![](\img\41.png)

#### 6.会话变量与系统变量

会话变量相当于只存在于一次会话中，会话结束就终止生命；系统变量是属于系统的，不会随着会话结束而消失

![](\img\32.png)



存储过程--一组sql语句的集合

set存储过程为变量赋值

@descripate  @代表用户的变量

select concat（）传输出结果，输出函数

存储函数使用 select 存储函数 来调用

存储引擎是基于表的，而不是基于库的



show ENGINES

mysql的环境变量

SHOW VARIABLES LIKE '%STORAGE_engine'

外键可以再删除时取到约束作用

数据库层面的优化

优化sql步骤

1.查看sql的执行频率

show status

显示当前连接的数据库的各类操作频率

```
show status like 'Com_______';
```



```
show global status like 'Com________';
```

查看innodb执行操作时影响的行数

```
show status like 'Innodb_rows_%'
```

2.定位低效率执行sql

3.explain分析执行计划

 3.1explian之id

多表操作时，如果id值相同，表示从上到下执行表

不同，则值越大优先级越高

id控制表执行的顺序

3.2 explain之 select_type

3.3 explain之 type

3.4 explain之 key

3.5  explain之 rows

3.6 explain之 extra

4.show profile 分析SQL  

```
查看数据库是否具有这个功能
SELECT @@have_profiling
查看是否开启profile功能 0 未开启  1开启
select @@profiling
开启功能
set profiling=1
。。。。。
对数据库进行操作
。。。。。

show profiles  查看刚刚的数据库sql执行情况和耗时

show profile for query 5   5代表show profile 查询出的执行表中的idwei5
的sql的各阶段执行时间

show profile all for query 5 更详细的信息
```

5.Trace分析优化器执行计划

用来分析mysql的优化器

6.索引的使用 

6.1 索引的使用

 6.1.1 联合索引

6.2 索引的失效



建立复合索引的情况，key_len 索引的长度，可以看出是否走索引，走了几个索引

  1.避免索引失效

​    1.1   全值匹配 

  对索引所有列都指定具体的值，该情况下，索引生效，执行效率高

​    1.2   最左前缀法则

   如果索引了多列，要遵守最左前缀法则，指的是查询从索引的最左前列开始，并且不跳过索引中的列

 如果对 A B C建立索引(A,B,C索引顺序按此排列)

1.查询条件中有 A,B  走索引

2.查询条件中有 A,C 走索引,但只走A的索引

3.查询条件中有 B,C 没有A  不走索引

4.查询条件中有B,C,A  走索引-->虽然顺序不对，但是条件语句是看你是否有最左索引，而不是严格按照顺序

对索引的使用，类似于爬楼 A 1楼   B 二楼   C 三楼，索引之间具有连接线，和接力性

1.3 范围查询右边的列，不使用索引

在between右边的列，是不走索引的

1.4 不要再索引列上进行运算操作，否则将失效

  对索引进行计算

vachar类型的不加 ‘’ ，会进行隐式类型转换，也相当于进行了运算

1.5 尽量避免使用select *

当索引中包含了我们要查询的列，不用回表查询，如果索引中不包含我们要查询的列

我们就要回表查询



6.用or分割的

or左右的字段都是使用索引的字段，有一个没有使用就不会走索引 

7.以like模糊匹配的，字段以%开头的，索引失效

%科技   索引失效

科技% 走索引

%科技% 不走索引

如何解决：

select 索引1，【索引2....】from table where  xx like '%科技%’    //走索引



8.如果mysql评估使用索引比全表扫描慢，就不走索引

select * from table where city='北京市'

当mysql发现，虽然city字段建立了索引，但大多数的表记录都是北京市，这个时候还不如全表扫描

9.is null,is not null 有时索引失效

涉及到mysql对索引使用时对数据的扫描量，以及全表查找数据时对数据的扫描量，这是作为mysql是否使用索引的一个判断的重要依据



10. in/not in

    in 走索引，not in 索引失效

11. 单列索引和复合索引

    尽量使用复合索引，而不是单列索引

    复合： create index idx_name_sta_address on table(name,status,address)

    ----------------------------------------------------------

    单列：不用考虑最左前缀法则

    ​            create index idx_name on table(name)

    ​            create index idx_sta on table(status)

    ​            create index idx_address on table(address)

数据库会选择一个最优的索引来使用，而不是全部的索引

select * from table where 条件1，条件2，条件3

会选择条件中，最优的的索引来确定数据（所以单列索引只会使用一个索引）

-----------------------------------------------------------------------

7.查看索引的使用

8，sql优化

8.1 大批量插入数据

1.通过load指令来导入数据

2.当前表结构中索引存在唯一性索引，会发生唯一性校验，影响性能，我们可以在load date之前

关闭唯一性索引校验，load date之后，打开唯一性索引校验

3.手动提交事务

8.2 优化insert语句

8.3 优化order by 

 1.filesort 文件系统排序

2.使用索引排序  多字段排序，按照索引的顺序设置值

3.对filesort的优化

8.4 优化group by

8.5 优化嵌套查询（子查询）

8.5 优化or查询

建议使用union来替换or

8.6 limit优化

8.7 使用SQL提示  

相当于由人为的去给数据库参考是否使用索引，以及使用哪个索引

但真正决定的还是数据库自己，而force是强制数据库取执行自定义的选择

应用程序的优化

1.应用优化

1.1 使用连接池

1.2 减少对mysql的访问

1.2.1 避免对数据库进行重复检索

1.2.2 增加cache层

1.3 负载均衡

2.Mysql中查询缓存优化

2.1 查询缓存参数配置

1.  查询是否有缓存能力

   ```sql
   show variables like 'have_query_cache'
   ```

2.  查询是否开启

   ```sql
   show variables like 'query_cache_type'
   ```

3. 查询缓存大小，容量不够可以增大

   ```sql
   show variables like 'query_cache_size'
   ```

4. 查询缓存的状态信息

   ```sql
   show status like 'Qcache'
   ```

   2.2 如何开启缓存

   2.3 查询缓存的SELECT选项

   2.4 查询缓存失效的情况

   2.5 mysql内存管理及优化

   1. 内存优化原则 

   2. MyISAM内存优化

   3. InnoDB内存优化

      

      2.6 MySQL并发参数调整

      2.7 Mysql锁问题

      读锁：表示当前数据只能读取，而不能进行其他的操作

      当你对一张表加了读锁，你不会阻塞其他线程的读操作，而会阻塞写操作

      当你对一张加了读锁的进行读操作，而没有释放锁，那么，这时你无法对其他表进行读操作

       1.MyISAM表锁

      

      ```
      show open tables   查看当前那张表正在使用
      ```

      

      2.InnoDB行锁

      为什么innodb支持事务，因为它采用的是行级锁

        1.InnoDB的行锁模式

      ```
      set autocommit=0; //关闭自动提交
      ```

      

   事务的隔离级别，可以使得不同事务之间，对同一个数据的操作互不影响

   ​      2.无索引行锁升级为表锁

   当sql语句where后面的字段，不通过索引来进行操作时，行锁升级为表锁，应为不通过索引来取数据，那么就得通过全表扫描，这时为了安全性，就得对表进行锁定

   3.间接锁的危害

   4.InnoDB的行锁争用情况

   2.7 常用的SQL技巧

     1.执行顺序

   2.正则表达式

   3.MySQL中的函数

     1.数字函数

   2.字符串函数

   3.日期函数

   4.聚合函数

   -----------------------------------------------------------------

   1.Mysql中常用工具

   1.2.连接选项

   1. 3.执行选项

   1.4.mysqladmin

     不需要进入命令行对数据库进行操作

   1.5.mysqlbinlog

   用来查看mysql的日志

   1.6.mysqldump

   1.7.mysqlimport/source

   1.9.mysqlshow

   2.mysql日志

   2.1 错误日志

   2.2 二进制日志

     1.查看STATEMENT日志格式

   2. 查看ROW日志格式
   3. 日志的删除

   2.3 查询日志

   2.4 慢查询日志

   3.mysql的复制

     3.1 主节点的配置

    3.2 从节点的配置

   4.Mysql高级案例

   1，AOP切面

   
   
   
   
   

